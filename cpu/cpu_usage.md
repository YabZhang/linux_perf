### CPU使用率



#### 概念

1. CPU 使用率，就是除了空闲时间外的其他时间占总 CPU 时间的百分比

#### 原理

1. Linux 作为一个多任务系统，将每个 CPU 时间划分为很短的时间片，再通过调度器分配给各个任务使用

2. Linux 使用节拍率（Hz）来触发时间中断，再任务中间完成必要的调度和切换工作；

   * `grep 'CONFIG_HZ=' /boot/config-$(uname -r)`
   * `cat /proc/stat | grep ^cpu` 查看系统内部状态(累计值！)

   ```bash
   root@b34efb93a7fd:/# cat /proc/stat | grep cpu
   cpu  134237 0 440816 50931752 475 0 370 0 0 0
   cpu0 33720 0 111497 12713269 159 0 229 0 0 0
   cpu1 33996 0 110410 12744960 115 0 50 0 0 0
   cpu2 33103 0 113855 12715339 88 0 55 0 0 0
   cpu3 33417 0 105052 12758182 111 0 35 0 0 0
   ```

   

3. 性能分析工具给出的都是间隔一段时间的平均 CPU 使用率，所以要注意间隔时间的设置

   

#### 工具

1. `top` : 系统总体的CPU和内存使用情况，以及各个进程的资源使用
2. `ps`：每个进程的资源使用
3. `pidstat`: 分析每个进程CPU使用情况



#### 案例分析

CPU 使用过高怎么办？

1. 通过`top`, `ps`, 或`pidstat`首先定位到具体的进程

2. 通过`perf`（linux内置的性能分析工具；基于时间采样）分析应用程序性能；GDB适用于后期分析

   * `perf top`，分析占用CPU时钟最多的函数或指令；采样数样本量需要足够大（至少千级别）

   * `perf record` 或 `perf report`；保存数据&分析数据

   `perf top` 和 `perf record` 添加 `-g`参数用于记录调用关系



进程分析：

```bash
# -g开启调用关系分析，-p指定php-fpm的进程号21515
$ perf top -g -p 21515
```



#### 总结

1. Linux通过时间片分给不多任务实现多任务；
2. CPU使用率的概念，以及查看工具`ps`, `top`, `pidstat；`
3. 应用程序性能分析工具`perf`的两种使用方式，可以用于前期定位到应用的源码函数；