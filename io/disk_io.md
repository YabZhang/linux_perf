## Linux 磁盘IO



#### 基本概念

* 磁盘，是可以持久化存储的设备；根据介质可分为`机械磁盘`和`固态磁盘`;

  1. 机械磁盘，也曾为硬盘驱动器，HDD; 主要由盘片和读写刺头组成，数据存储在盘片的环状磁道中；读写数据前需要定位数据所在磁道(寻道)，然后才能访问数据。顺序IO不需要重复寻道，有更好的性能；
  2. 固态磁盘，缩写为SSD; 固态磁盘由固态电子器件组成，不需要寻道，所以不管是连续IO还是随机IO性能都好于HDD;

  机械磁盘最小读写单位是扇区，一般为512B; 固态磁盘最小读写单位是页，通常是4KB或8KB;

  磁盘接口：IDE, SCSI, SAS, SATA, FC等；

  把多块磁盘组合成一个逻辑磁盘，构成冗余独立磁盘阵列 `RAID`, 可以提高数据访问性能和可靠性；

  RAID0 又最有读写性能，但不提供数据冗余；

* 通用块层，处于文件系统和磁盘驱动之间的一个块设备抽象层

  1. 类似VFS，向上为文件系统和应用程序提供统一的访问接口，向下把各种异构的磁盘设备抽象为统一的块设备，并提供统一框架来管理；

  2. 把上层发来的IO请求排队，并通过重排序、请求合并等方式提高读写效率；

  3. Linux 支持四种 IO 调度算法: 

     a. NONE（不调度）;

     b. NOOP（先进先出，多用于ssd）

     c. CFQ（完全公平调度器）,每个进程一个IO调度队列，按照时间片来均匀分布进程请求；

     d. DeadLine（最终期限调度器），分别为读写创建不同IO队列，确保达到最终期限的请求优先被处理；多用在IO压力比较重的场景, 比如数据库等;

* IO 栈

  <img src="https://static001.geekbang.org/resource/image/14/b1/14bc3d26efe093d3eada173f869146b1.png" alt="全景图" style="zoom: 50%;" />



由上图，IO系统主要包括三层：

1. 文件系统层，包含虚拟文件系统和各种文件系统的具体实现；对上提供一致访问接口，对下通过通用快层来管理数据；
2. 通用快层，包括块设备IO队列和IO调度器，会对文件系统的IO请求进行排队，再重新排序和请求合并，然后才发送给下一级的设备层；
3. 设备层，包括存储设备和响应的驱动程序，负责最终的设备的IO操作；



* 磁盘性能指标
  1. 使用率， 指磁盘处理IO的时间百分比，过高意味着磁盘IO存在瓶颈；
  2. 饱和度，指磁盘处理IO的繁忙程度，过高的饱和度，以为这磁盘存在严重性能瓶颈；当饱和度为100%时，磁盘无法接受新的IO请求；
  3. IOPS （Input/Output Per Second）, 每秒的 IO 请求数;
  4. 吞吐量，指每秒的 IO 请求大小；
  5. 吞吐时间，IO请求从发出到收到响应的间隔时间；



* 磁盘 IO 观测

  1. iostat 观测磁盘各种指标, 数据来自于`/proc/diskstats`

     ```bash
     $ iostat -d -x 1  # -d -x 表示显示所有磁盘IO的指标
     ```

     

     <img src="https://static001.geekbang.org/resource/image/cf/8d/cff31e715af51c9cb8085ce1bb48318d.png" alt="iostat指标" style="zoom: 33%;" />

     * %util ，就是我们前面提到的磁盘 I/O 使用率；

     * r/s+ w/s ，就是 IOPS；

     * rkB/s+wkB/s ，就是吞吐量；

     * r_await+w_await ，就是响应时间。

2. 进程 IO 观测

   ```bash
   $ pidstat -d 1 
   13:39:51      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command 
   13:39:52      102       916      0.00      4.00      0.00       0  rsyslogd
   ```

   

   输出的列内容依次是：

   用户 ID（UID）和进程 ID（PID） 。

   每秒读取的数据大小（kB_rd/s） ，单位是 KB。

   每秒发出的写请求数据大小（kB_wr/s） ，单位是 KB。

   每秒取消的写请求数据大小（kB_ccwr/s） ，单位是 KB。

   块 I/O 延迟（iodelay），包括等待同步块 I/O 和换入块 I/O 结束的时间，单位是时钟周期。